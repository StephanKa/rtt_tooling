name: ARM GCC Build and Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  build-arm:
    name: Build for ARM (STM32F205)
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install ARM GCC toolchain
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-arm-none-eabi binutils-arm-none-eabi libnewlib-arm-none-eabi
        arm-none-eabi-gcc --version

    - name: Install Ninja
      run: |
        sudo apt-get install -y ninja-build
        ninja --version

    - name: Configure CMake for ARM
      run: |
        cmake --preset arm-stm32f205

    - name: Build for ARM
      run: |
        cmake --build --preset arm-stm32f205

    - name: Generate binary statistics
      run: |
        bash scripts/generate_binary_stats.sh build/arm-stm32f205 "Debug"

  build-arm-release:
    name: Build for ARM (Release)
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install ARM GCC toolchain
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-arm-none-eabi binutils-arm-none-eabi libnewlib-arm-none-eabi

    - name: Install Ninja
      run: |
        sudo apt-get install -y ninja-build

    - name: Configure CMake for ARM (Release)
      run: |
        cmake --preset arm-stm32f205-release

    - name: Build for ARM (Release)
      run: |
        cmake --build --preset arm-stm32f205-release

    - name: Generate binary statistics
      run: |
        bash scripts/generate_binary_stats.sh build/arm-stm32f205-release "Release"

  build-native:
    name: Build Native (Debug)
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ninja-build

    - name: Configure CMake
      run: |
        cmake --preset default

    - name: Build
      run: |
        cmake --build --preset default

  test:
    name: Run Unit Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ninja-build

    - name: Configure CMake with testing
      run: |
        cmake --preset testing

    - name: Build tests
      run: |
        cmake --build --preset testing

    - name: Run tests
      run: |
        cd build/testing
        ctest --output-on-failure --verbose

  python-lint-and-test:
    name: Python Linting and Testing
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install uv
      run: |
        pip install uv

    - name: Create virtual environment
      run: |
        uv venv

    - name: Install dependencies
      run: |
        uv pip install -e ".[dev]"

    - name: Run black (check only)
      run: |
        source .venv/bin/activate
        black --check scripts/ tests/

    - name: Run ruff
      run: |
        source .venv/bin/activate
        ruff check scripts/ tests/

    - name: Run pylint
      run: |
        source .venv/bin/activate
        pylint scripts/ tests/

    - name: Run mypy
      run: |
        source .venv/bin/activate
        mypy scripts/ tests/

    - name: Run pytest
      run: |
        source .venv/bin/activate
        pytest tests/ --cov=scripts --cov-report=term --cov-report=xml

    - name: Upload coverage reports
      uses: codecov/codecov-action@v4
      if: always()
      with:
        file: ./coverage.xml
        fail_ci_if_error: false
        token: ${{ secrets.CODECOV_TOKEN }}
